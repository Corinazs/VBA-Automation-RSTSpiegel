Sub SheetsAktualieren0002()

Dim ws As Workbook
Set ws = ThisWorkbook
Dim gesellschaft As Worksheet
Set gesellschaft = ws.Sheets("0002_ratiopharm")

letzteZeileSheets = gesellschaft.Cells(Rows.Count, 3).End(xlUp).Row
letzteZeilealt = gesellschaft.Cells(Rows.Count, 12).End(xlUp).Row


'Daten leeren
gesellschaft.Range("L5:S" & letzteZeilealt) = ""

For i = 5 To letzteZeileSheets + 2 'läuft runter
    'AB=R00
    If (gesellschaft.Cells(4, 5).Value = "R00") Then
        gesellschaft.Cells(i, 12).Value = -gesellschaft.Cells(i, 5).Value
    End If
    
    'Verbrauch = R02
    If (gesellschaft.Cells(4, 7).Value = "R02") Then
        gesellschaft.Cells(i, 14).Value = -(gesellschaft.Cells(i, 7).Value)
    End If
    
    'Auflösung = R03
     If (gesellschaft.Cells(4, 8).Value = "R03") Then
        gesellschaft.Cells(i, 15).Value = -(gesellschaft.Cells(i, 8).Value)
     End If
    
   'Zuführung = R01+R06+R07
    If (gesellschaft.Cells(4, 6).Value = "R01" And gesellschaft.Cells(4, 9).Value = "R06" And gesellschaft.Cells(4, 10).Value = "R07") Then 'R03+R06+R07=Zuführung
        gesellschaft.Cells(i, 16).Value = -gesellschaft.Cells(i, 6).Value - gesellschaft.Cells(i, 9).Value - gesellschaft.Cells(i, 10).Value
    End If
    'falls nur R01 vorhanden laut Auswertung
    If (gesellschaft.Cells(4, 6).Value = "R01" And gesellschaft.Cells(4, 9).Value <> "R06" And gesellschaft.Cells(4, 10).Value <> "R07") Then 'R01+R06+R07=Zuführung
        gesellschaft.Cells(i, 16).Value = -gesellschaft.Cells(i, 6).Value
    End If
    'falls nur R01+R06 vorhanden laut Auswertung
    If (gesellschaft.Cells(4, 6).Value = "R01" And gesellschaft.Cells(4, 9).Value = "R06" And gesellschaft.Cells(4, 10).Value <> "R07") Then 'R01+R06+R07=Zuführung
        gesellschaft.Cells(i, 16).Value = -gesellschaft.Cells(i, 6).Value - gesellschaft.Cells(i, 9).Value
    End If
    'falls nur R01+R07 vorhanden laut Auswertung
    If (gesellschaft.Cells(4, 6).Value = "R01" And gesellschaft.Cells(4, 9).Value = "R07") Then 'R01+R06+R07=Zuführung
        gesellschaft.Cells(i, 16).Value = -gesellschaft.Cells(i, 6).Value - gesellschaft.Cells(i, 9).Value
    End If
    'falls nur R06+R07 vorhanden laut Auswertung
    If (gesellschaft.Cells(4, 8).Value = "R06" And gesellschaft.Cells(4, 9).Value = "R07") Then 'R01+R06+R07=Zuführung
        gesellschaft.Cells(i, 16).Value = -gesellschaft.Cells(i, 6).Value - gesellschaft.Cells(i, 9).Value
    End If
       
    'EB
    gesellschaft.Cells(i, 17).Value = gesellschaft.Cells(i, 12).Value + gesellschaft.Cells(i, 13).Value + gesellschaft.Cells(i, 14).Value + gesellschaft.Cells(i, 15).Value + gesellschaft.Cells(i, 16).Value
    
    'Offen aus VJ
    gesellschaft.Cells(i, 19).Value = gesellschaft.Cells(i, 12).Value + gesellschaft.Cells(i, 14).Value + gesellschaft.Cells(i, 15).Value
    
Next

Dim arr_speicher(50) As Integer
'finde die Zwischensummen
k = 0
letzteZeileSheets = gesellschaft.Cells(Rows.Count, 3).End(xlUp).Row

For i = 1 To letzteZeileSheets + 1
        If (gesellschaft.Range("C" & i).MergeCells) Then 'Wenn in B verbundene Zellen = Zwischensumme
            zs = i 'merke in welcher Zeile Zwischensumme
            arr_speicher(k) = zs
            k = k + 1
        End If
Next

'alte Formatierung löschen
    With gesellschaft.Range("L5:S" & 500).Interior
        .Pattern = xlNone
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    gesellschaft.Range("L5:S" & 500).Borders(xlDiagonalDown).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlDiagonalUp).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlEdgeLeft).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlEdgeTop).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlEdgeBottom).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlEdgeRight).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlInsideVertical).LineStyle = xlNone
    gesellschaft.Range("L5:S" & 500).Borders(xlInsideHorizontal).LineStyle = xlNone

'Währung und Format anpassen
 gesellschaft.Range("L5:S" & letzteZeileSheets + 2).NumberFormat = "$#,##0.00_);[Red]($#,##0.00)"
k = 0
i = arr_speicher(k)
    While (arr_speicher(k) <> 0)
        gesellschaft.Range("B" & i & ":S" & i).Font.Bold = True
        With gesellschaft.Range("B" & i & ":S" & i).Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorAccent6
            .TintAndShade = 0.599993896298105
            .PatternTintAndShade = 0
        End With
        k = k + 1
        i = arr_speicher(k)
    Wend
'blau
    gesellschaft.Range("L" & letzteZeileSheets + 2 & ":S" & letzteZeileSheets + 2).Font.Bold = True
        With gesellschaft.Range("L" & letzteZeileSheets + 2 & ":S" & letzteZeileSheets + 2).Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorAccent1
            .TintAndShade = 0.799981688894314
            .PatternTintAndShade = 0
        End With
        
    gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlDiagonalDown).LineStyle = xlNone
    gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlDiagonalUp).LineStyle = xlNone
    With gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With gesellschaft.Range("L5:S" & letzteZeileSheets + 2).Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    
    gesellschaft.Range("R2").Copy
    gesellschaft.Range("R5:R" & letzteZeileSheets + 2).PasteSpecial Paste:=xlPasteFormats, Operation:=xlNone, _
        SkipBlanks:=False, Transpose:=False
    Application.CutCopyMode = False
    

End Sub

